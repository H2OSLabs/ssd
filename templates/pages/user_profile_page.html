{% extends "layouts/three_pane_layout.html" %}
{% load static humanize %}
{% comment %}
    User Profile Page Template

    Context Variables Required:
    - profile_user: User object with attributes:
        - username, first_name, last_name, bio
        - avatar (optional): URL to user avatar image
        - level, xp, xp_for_next_level: Gamification stats
        - role: User role (hacker/hipster/hustler)
        - reputation, quests_completed, teams_joined: User stats
        - recent_submissions: QuerySet of recent submission objects
        - skills: List of skill objects with 'name' and 'is_verified' attributes
        - current_teams, past_teams: QuerySets of team objects
        - projects: List of project objects with name, description, url, tech_stack
        - activity_history: List of activity objects with action and date
        - seeking_team (optional): Boolean indicating if user is seeking a team
{% endcomment %}

{% block navigation_sidebar %}
    {% include "components/nav-sidebar.html" with active_section="profile" %}
{% endblock %}

{% block main_content %}
<div class="p-gh-6 space-y-gh-6">
    {# Hero Section #}
    <section class="bg-gradient-to-r from-gh-bg-muted to-gh-bg-subtle dark:from-gray-800 dark:to-gray-900 rounded-gh-lg p-gh-6 border border-gh-border-default dark:border-gray-700">
        <div class="flex flex-col md:flex-row items-start md:items-center gap-gh-6">
            {# Avatar #}
            <div class="flex-shrink-0">
                {% if profile_user.avatar %}
                    <img src="{{ profile_user.avatar }}" alt="{{ profile_user.username }}" class="w-32 h-32 rounded-full border-4 border-white dark:border-gray-700 shadow-gh-card">
                {% else %}
                    <div class="w-32 h-32 rounded-full bg-gh-accent-emphasis dark:bg-gh-accent-muted flex items-center justify-center text-white font-bold text-4xl border-4 border-white dark:border-gray-700 shadow-gh-card">
                        {{ profile_user.first_name|first|default:profile_user.username|first|default:"U"|upper }}{{ profile_user.last_name|first|upper }}
                    </div>
                {% endif %}
            </div>

            {# User Info #}
            <div class="flex-1 min-w-0">
                <h1 class="text-4xl font-bold text-gh-neutral-emphasis dark:text-white mb-gh-2">
                    {% if profile_user.first_name or profile_user.last_name %}
                        {{ profile_user.first_name }} {{ profile_user.last_name }}
                    {% else %}
                        {{ profile_user.username }}
                    {% endif %}
                </h1>

                {% if profile_user.username %}
                <p class="text-lg text-gh-neutral-muted dark:text-gh-neutral-muted mb-gh-3">@{{ profile_user.username }}</p>
                {% endif %}

                {% if profile_user.bio %}
                <p class="text-base text-gh-neutral-default dark:text-gh-neutral-default mb-gh-4">{{ profile_user.bio }}</p>
                {% endif %}

                {# Level and XP Progress #}
                <div class="mb-gh-3">
                    <div class="flex items-center gap-gh-3 mb-gh-2">
                        <span class="inline-flex items-center px-3 py-1 rounded-gh bg-gh-accent-subtle dark:bg-gh-accent-emphasis text-gh-accent-emphasis dark:text-white font-semibold text-sm">
                            Level {{ profile_user.level|default:"1" }}
                        </span>
                        <span class="text-sm text-gh-neutral-muted dark:text-gh-neutral-muted">
                            {{ profile_user.xp|default:"0" }} / {{ profile_user.xp_for_next_level|default:"1000" }} XP
                        </span>
                    </div>
                    {# XP Progress Bar #}
                    <div class="w-full bg-gh-bg-muted dark:bg-gray-700 rounded-full h-2 overflow-hidden">
                        {% widthratio profile_user.xp|default:"0" profile_user.xp_for_next_level|default:"1000" 100 as xp_percentage %}
                        <div class="bg-gh-accent-emphasis dark:bg-gh-accent-muted h-full rounded-full transition-all duration-500" style="width: {{ xp_percentage }}%"></div>
                    </div>
                </div>

                {# Role Badge #}
                {% if profile_user.role %}
                <span class="inline-flex items-center px-3 py-1 rounded-gh {% if profile_user.role == 'hacker' %}bg-gh-success-subtle text-gh-success-emphasis dark:bg-gh-success-emphasis dark:text-white{% elif profile_user.role == 'hipster' %}bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200{% elif profile_user.role == 'hustler' %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200{% endif %} font-semibold text-sm">
                    {{ profile_user.role|capfirst }}
                </span>
                {% endif %}
            </div>
        </div>
    </section>

    {# Tab Navigation #}
    <div x-data="{ activeTab: 'overview' }" class="space-y-gh-4">
        {# Sticky Tab Navigation #}
        <nav class="sticky top-0 z-10 bg-gh-bg-default dark:bg-gray-900 border-b border-gh-border-default dark:border-gray-700 -mx-gh-6 px-gh-6 py-gh-3" role="tablist" aria-label="Profile sections">
            <div class="flex gap-gh-1 overflow-x-auto no-scrollbar">
                <button
                    @click="activeTab = 'overview'"
                    :class="activeTab === 'overview' ? 'border-gh-accent-emphasis dark:border-gh-accent-muted text-gh-neutral-emphasis dark:text-white font-semibold' : 'border-transparent text-gh-neutral-muted dark:text-gh-neutral-muted hover:text-gh-neutral-default dark:hover:text-gh-neutral-default hover:border-gh-border-default dark:hover:border-gray-600'"
                    class="px-gh-4 py-gh-2 border-b-2 transition-colors whitespace-nowrap text-sm"
                    role="tab"
                    :aria-selected="activeTab === 'overview'"
                    aria-controls="overview-panel">
                    Overview
                </button>
                <button
                    @click="activeTab = 'teams'"
                    :class="activeTab === 'teams' ? 'border-gh-accent-emphasis dark:border-gh-accent-muted text-gh-neutral-emphasis dark:text-white font-semibold' : 'border-transparent text-gh-neutral-muted dark:text-gh-neutral-muted hover:text-gh-neutral-default dark:hover:text-gh-neutral-default hover:border-gh-border-default dark:hover:border-gray-600'"
                    class="px-gh-4 py-gh-2 border-b-2 transition-colors whitespace-nowrap text-sm"
                    role="tab"
                    :aria-selected="activeTab === 'teams'"
                    aria-controls="teams-panel">
                    Teams
                </button>
                <button
                    @click="activeTab = 'projects'"
                    :class="activeTab === 'projects' ? 'border-gh-accent-emphasis dark:border-gh-accent-muted text-gh-neutral-emphasis dark:text-white font-semibold' : 'border-transparent text-gh-neutral-muted dark:text-gh-neutral-muted hover:text-gh-neutral-default dark:hover:text-gh-neutral-default hover:border-gh-border-default dark:hover:border-gray-600'"
                    class="px-gh-4 py-gh-2 border-b-2 transition-colors whitespace-nowrap text-sm"
                    role="tab"
                    :aria-selected="activeTab === 'projects'"
                    aria-controls="projects-panel">
                    Projects
                </button>
                <button
                    @click="activeTab = 'history'"
                    :class="activeTab === 'history' ? 'border-gh-accent-emphasis dark:border-gh-accent-muted text-gh-neutral-emphasis dark:text-white font-semibold' : 'border-transparent text-gh-neutral-muted dark:text-gh-neutral-muted hover:text-gh-neutral-default dark:hover:text-gh-neutral-default hover:border-gh-border-default dark:hover:border-gray-600'"
                    class="px-gh-4 py-gh-2 border-b-2 transition-colors whitespace-nowrap text-sm"
                    role="tab"
                    :aria-selected="activeTab === 'history'"
                    aria-controls="history-panel">
                    History
                </button>
            </div>
        </nav>

        {# Tab Panels #}

        {# Overview Tab #}
        <div
            x-show="activeTab === 'overview'"
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 transform translate-y-2"
            x-transition:enter-end="opacity-100 transform translate-y-0"
            id="overview-panel"
            role="tabpanel"
            aria-labelledby="overview-tab"
            class="space-y-gh-6">

            {# Stats Grid #}
            <div class="grid grid-cols-2 md:grid-cols-4 gap-gh-4">
                <div class="card-gh p-gh-4 text-center hover:shadow-gh-card-hover transition-shadow">
                    <div class="text-3xl font-bold text-gh-accent-fg dark:text-gh-accent-muted mb-gh-1">
                        {{ profile_user.xp|default:"0"|intcomma }}
                    </div>
                    <div class="text-sm text-gh-neutral-muted dark:text-gh-neutral-muted">Total XP</div>
                </div>
                <div class="card-gh p-gh-4 text-center hover:shadow-gh-card-hover transition-shadow">
                    <div class="text-3xl font-bold text-gh-accent-fg dark:text-gh-accent-muted mb-gh-1">
                        {{ profile_user.reputation|default:"0"|intcomma }}
                    </div>
                    <div class="text-sm text-gh-neutral-muted dark:text-gh-neutral-muted">Reputation</div>
                </div>
                <div class="card-gh p-gh-4 text-center hover:shadow-gh-card-hover transition-shadow">
                    <div class="text-3xl font-bold text-gh-accent-fg dark:text-gh-accent-muted mb-gh-1">
                        {{ profile_user.quests_completed|default:"0" }}
                    </div>
                    <div class="text-sm text-gh-neutral-muted dark:text-gh-neutral-muted">Quests Completed</div>
                </div>
                <div class="card-gh p-gh-4 text-center hover:shadow-gh-card-hover transition-shadow">
                    <div class="text-3xl font-bold text-gh-accent-fg dark:text-gh-accent-muted mb-gh-1">
                        {{ profile_user.teams_joined|default:"0" }}
                    </div>
                    <div class="text-sm text-gh-neutral-muted dark:text-gh-neutral-muted">Teams Joined</div>
                </div>
            </div>

            {# Recent Submissions #}
            {% if profile_user.recent_submissions %}
            <section>
                <h2 class="text-2xl font-bold text-gh-neutral-emphasis dark:text-white mb-gh-4">Recent Submissions</h2>
                <div class="space-y-gh-4">
                    {% for submission in profile_user.recent_submissions|slice:":3" %}
                        {% include "components/submission-card.html" with submission=submission %}
                    {% endfor %}
                </div>
            </section>
            {% endif %}

            {# Skills Section #}
            {% if profile_user.skills %}
            <section class="card-gh p-gh-6">
                <h2 class="text-2xl font-bold text-gh-neutral-emphasis dark:text-white mb-gh-4">Skills</h2>
                <div class="flex flex-wrap gap-gh-2">
                    {% for skill in profile_user.skills %}
                    <span class="inline-flex items-center gap-gh-2 px-3 py-1 rounded-gh bg-gh-bg-subtle dark:bg-gray-800 text-gh-neutral-default dark:text-gh-neutral-default text-sm border border-gh-border-default dark:border-gray-700">
                        {{ skill.name }}
                        {% if skill.is_verified %}
                        <svg class="w-4 h-4 text-gh-success-emphasis dark:text-gh-success-muted" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
                        </svg>
                        {% endif %}
                    </span>
                    {% endfor %}
                </div>
            </section>
            {% endif %}
        </div>

        {# Teams Tab #}
        <div
            x-show="activeTab === 'teams'"
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 transform translate-y-2"
            x-transition:enter-end="opacity-100 transform translate-y-0"
            id="teams-panel"
            role="tabpanel"
            aria-labelledby="teams-tab"
            class="space-y-gh-6">

            {# Current Teams #}
            {% if profile_user.current_teams %}
            <section>
                <h2 class="text-2xl font-bold text-gh-neutral-emphasis dark:text-white mb-gh-4">Current Teams</h2>
                <div class="grid gap-gh-4 md:grid-cols-2">
                    {% for team in profile_user.current_teams %}
                        {% include "components/team-card.html" with team=team %}
                    {% endfor %}
                </div>
            </section>
            {% else %}
            <div class="card-gh p-gh-6 text-center">
                <p class="text-gh-neutral-muted dark:text-gh-neutral-muted">Not currently on any teams</p>
            </div>
            {% endif %}

            {# Past Teams #}
            {% if profile_user.past_teams %}
            <section>
                <h2 class="text-2xl font-bold text-gh-neutral-emphasis dark:text-white mb-gh-4">Past Teams</h2>
                <div class="grid gap-gh-4 md:grid-cols-2">
                    {% for team in profile_user.past_teams %}
                        {% include "components/team-card.html" with team=team %}
                    {% endfor %}
                </div>
            </section>
            {% endif %}
        </div>

        {# Projects Tab #}
        <div
            x-show="activeTab === 'projects'"
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 transform translate-y-2"
            x-transition:enter-end="opacity-100 transform translate-y-0"
            id="projects-panel"
            role="tabpanel"
            aria-labelledby="projects-tab"
            class="space-y-gh-4">

            {% if profile_user.projects %}
                {% for project in profile_user.projects %}
                <article class="card-gh p-gh-6 hover:shadow-gh-card-hover transition-shadow">
                    <h3 class="text-xl font-semibold text-gh-neutral-emphasis dark:text-white mb-gh-2">
                        {% if project.url %}
                        <a href="{{ project.url }}" class="hover:text-gh-accent-fg dark:hover:text-gh-accent-muted" target="_blank" rel="noopener noreferrer">
                            {{ project.name }}
                            <svg class="inline-block w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                            </svg>
                        </a>
                        {% else %}
                        {{ project.name }}
                        {% endif %}
                    </h3>

                    {% if project.description %}
                    <p class="text-sm text-gh-neutral-default dark:text-gh-neutral-default mb-gh-4">{{ project.description }}</p>
                    {% endif %}

                    {% if project.tech_stack %}
                    <div class="flex flex-wrap gap-gh-2">
                        {% for tech in project.tech_stack %}
                        <span class="px-2 py-1 bg-gh-bg-subtle dark:bg-gray-800 text-gh-neutral-muted dark:text-gh-neutral-muted rounded text-xs border border-gh-border-default dark:border-gray-700">
                            {{ tech }}
                        </span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </article>
                {% endfor %}
            {% else %}
            <div class="card-gh p-gh-6 text-center">
                <p class="text-gh-neutral-muted dark:text-gh-neutral-muted">No projects to display</p>
            </div>
            {% endif %}
        </div>

        {# History Tab #}
        <div
            x-show="activeTab === 'history'"
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 transform translate-y-2"
            x-transition:enter-end="opacity-100 transform translate-y-0"
            id="history-panel"
            role="tabpanel"
            aria-labelledby="history-tab"
            class="space-y-gh-4">

            {% if profile_user.activity_history %}
            <div class="card-gh p-gh-6">
                <h2 class="text-2xl font-bold text-gh-neutral-emphasis dark:text-white mb-gh-6">Activity Timeline</h2>
                <div class="space-y-gh-4">
                    {% for activity in profile_user.activity_history %}
                    <div class="flex gap-gh-4 pb-gh-4 border-b border-gh-border-default dark:border-gray-700 last:border-b-0">
                        {# Timeline dot #}
                        <div class="flex-shrink-0 w-3 h-3 mt-1 rounded-full bg-gh-accent-emphasis dark:bg-gh-accent-muted"></div>

                        <div class="flex-1 min-w-0">
                            <div class="flex items-baseline justify-between gap-gh-2 mb-gh-1">
                                <p class="text-sm text-gh-neutral-default dark:text-gh-neutral-default">{{ activity.action }}</p>
                                <time class="text-xs text-gh-neutral-muted dark:text-gh-neutral-muted whitespace-nowrap" datetime="{{ activity.date|date:'c' }}">
                                    {{ activity.date|naturaltime }}
                                </time>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div class="card-gh p-gh-6 text-center">
                <p class="text-gh-neutral-muted dark:text-gh-neutral-muted">No activity history to display</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block detail_sidebar %}
<div class="p-gh-6 space-y-gh-6">
    {# Quick Stats Card #}
    <section class="card-gh p-gh-6">
        <h2 class="text-lg font-semibold text-gh-neutral-emphasis dark:text-white mb-gh-4">Quick Stats</h2>
        <div class="space-y-gh-3">
            <div class="flex justify-between items-center">
                <span class="text-sm text-gh-neutral-muted dark:text-gh-neutral-muted">XP</span>
                <span class="text-sm font-semibold text-gh-neutral-emphasis dark:text-white">{{ profile_user.xp|default:"0"|intcomma }}</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm text-gh-neutral-muted dark:text-gh-neutral-muted">Level</span>
                <span class="text-sm font-semibold text-gh-neutral-emphasis dark:text-white">{{ profile_user.level|default:"1" }}</span>
            </div>
            <div class="flex justify-between items-center">
                <span class="text-sm text-gh-neutral-muted dark:text-gh-neutral-muted">Reputation</span>
                <span class="text-sm font-semibold text-gh-neutral-emphasis dark:text-white">{{ profile_user.reputation|default:"0"|intcomma }}</span>
            </div>
        </div>
    </section>

    {# Verified Skills #}
    {% if profile_user.skills %}
    <section class="card-gh p-gh-6">
        <h2 class="text-lg font-semibold text-gh-neutral-emphasis dark:text-white mb-gh-4">Verified Skills</h2>
        <div class="space-y-gh-2">
            {% for skill in profile_user.skills %}
                {% if skill.is_verified %}
                <div class="flex items-center gap-gh-2 text-sm">
                    <svg class="w-4 h-4 text-gh-success-emphasis dark:text-gh-success-muted flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-gh-neutral-default dark:text-gh-neutral-default">{{ skill.name }}</span>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </section>
    {% endif %}

    {# Seeking Team Widget #}
    {% if profile_user.seeking_team %}
    <section class="card-gh p-gh-6 bg-gh-success-subtle dark:bg-gh-success-emphasis border-gh-success-muted dark:border-gh-success-emphasis">
        <div class="flex items-start gap-gh-3">
            <svg class="w-5 h-5 text-gh-success-emphasis dark:text-white flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 9a3 3 0 1 0 0-6 3 3 0 0 0 0 6ZM6 8a2 2 0 1 1-4 0 2 2 0 0 1 4 0ZM1.49 15.326a.78.78 0 0 1-.358-.442 3 3 0 0 1 4.308-3.516 6.484 6.484 0 0 0-1.905 3.959c-.023.222-.014.442.025.654a4.97 4.97 0 0 1-2.07-.655ZM16.44 15.98a4.97 4.97 0 0 0 2.07-.654.78.78 0 0 0 .357-.442 3 3 0 0 0-4.308-3.517 6.484 6.484 0 0 1 1.907 3.96 2.32 2.32 0 0 1-.026.654ZM18 8a2 2 0 1 1-4 0 2 2 0 0 1 4 0ZM5.304 16.19a.844.844 0 0 1-.277-.71 5 5 0 0 1 9.947 0 .843.843 0 0 1-.277.71A6.975 6.975 0 0 1 10 18a6.974 6.974 0 0 1-4.696-1.81Z" />
            </svg>
            <div>
                <h3 class="text-sm font-semibold text-gh-success-emphasis dark:text-white mb-gh-1">Seeking Team</h3>
                <p class="text-xs text-gh-success-emphasis dark:text-white opacity-90">Available for team formation</p>
            </div>
        </div>
    </section>
    {% endif %}
</div>
{% endblock %}
